version: '3.9'

networks:
  nd_front:
  nd_back:

services:
  db:
    image: netdisco/netdisco:${NETDISCO_VERSION}-postgresql
    build:
      context: nd-psql
    networks:
      - nd_back
    restart: unless-stopped
    volumes:
      - ${PWD}/files/pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-d", "db_prod"]
      interval: 30s
      timeout: 60s
      retries: 5
      start_period: 80s 

  nd-backend:
    depends_on:
      - db
    image: "stelliferrous/netdisco:${NETDISCO_VERSION}"
    networks:
      - nd_back
    restart: unless-stopped
    environment:
      END: "backend"

  nd-frontend:
    depends_on:
      - db
      - nd-base
    image: "stelliferrous/netdisco:${NETDISCO_VERSION}"
    networks:
      - nd_front
      - nd_back
    restart: unless-stopped
    environment:
      END: "frontend"
    ports:
      - 5000:5000
    

